openapi: 3.0.3
info:
  title: Tiny Tasks API
  version: 1.0.0
  description: >
    Minimal task API with strict JSON handling, CORS, and optional persistence (memory/JSON/SQLite).

servers:
  - url: /

tags:
  - name: Tasks
  - name: CORS
  - name: Health

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Health' }
              examples:
                ok:
                  value: { status: "ok" }
        default:
          $ref: '#/components/responses/ErrorDefault'

  /tasks:
    get:
      tags: [Tasks]
      summary: List tasks
      responses:
        '200':
          description: Array of tasks
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Task' }
        '405':
          $ref: '#/components/responses/MethodNotAllowedCollection'
        default:
          $ref: '#/components/responses/ErrorDefault'

    post:
      tags: [Tasks]
      summary: Create task
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskCreate' }
            examples:
              ok:
                value: { title: "buy milk", due: "2025-12-31", completed: false }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Task' }
        '400':
          $ref: '#/components/responses/BadRequest'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '405':
          $ref: '#/components/responses/MethodNotAllowedCollection'
        default:
          $ref: '#/components/responses/ErrorDefault'

    options:
      tags: [CORS]
      summary: CORS preflight (collection)
      responses:
        '200':
          description: OK (CORS headers present on response)
        default:
          $ref: '#/components/responses/ErrorDefault'

  /tasks/{id}:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    get:
      tags: [Tasks]
      summary: Get a task
      responses:
        '200':
          description: Task
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Task' }
        '404':
          $ref: '#/components/responses/NotFound'
        '405':
          $ref: '#/components/responses/MethodNotAllowedItem'
        default:
          $ref: '#/components/responses/ErrorDefault'

    put:
      tags: [Tasks]
      summary: Update a task
      description: Provide any subset of fields; at least one is required.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TaskUpdate' }
            examples:
              setCompleted:
                value: { completed: true }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Task' }
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '405':
          $ref: '#/components/responses/MethodNotAllowedItem'
        default:
          $ref: '#/components/responses/ErrorDefault'

    delete:
      tags: [Tasks]
      summary: Delete a task
      responses:
        '204': { description: No Content }
        '404':
          $ref: '#/components/responses/NotFound'
        '405':
          $ref: '#/components/responses/MethodNotAllowedItem'
        default:
          $ref: '#/components/responses/ErrorDefault'

    options:
      tags: [CORS]
      summary: CORS preflight (item)
      responses:
        '200':
          description: OK (CORS headers present on response)
        default:
          $ref: '#/components/responses/ErrorDefault'

components:
  parameters:
    TaskId:
      name: id
      in: path
      required: true
      schema: { type: string }

  headers:
    Allow:
      description: Comma-separated list of allowed methods for this resource.
      schema:
        type: string
        example: GET, POST

  responses:
    BadRequest:
      description: Validation error or malformed JSON
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            malformedJson:
              value: { error: "Malformed JSON" }
            validation:
              value: { error: "Invalid 'due' (expected YYYY-MM-DD)" }

    UnsupportedMediaType:
      description: Content-Type must be application/json
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            wrongContentType:
              value: { error: "Unsupported Media Type (use application/json)" }

    PayloadTooLarge:
      description: Payload too large (exceeds MAX_BODY_BYTES)
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            tooLarge:
              value: { error: "Payload too large" }

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            missing:
              value: { error: "Not found" }

    MethodNotAllowedCollection:
      description: Method not allowed on /tasks
      headers:
        Allow:
          $ref: '#/components/headers/Allow'
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            methodNotAllowed:
              value: { error: "Method not allowed" }

    MethodNotAllowedItem:
      description: Method not allowed on /tasks/{id}
      headers:
        Allow:
          $ref: '#/components/headers/Allow'
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
          examples:
            methodNotAllowed:
              value: { error: "Method not allowed" }

    ErrorDefault:
      description: Error
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }

  schemas:
    Health:
      type: object
      additionalProperties: false
      properties:
        status:
          type: string
          example: ok
      required: [status]

    Task:
      type: object
      additionalProperties: false
      properties:
        id: { type: string }
        title:
          type: string
          minLength: 1
          maxLength: 200
          description: Non-empty; max length default 200 (configurable)
        due:
          type: string
          format: date
          description: YYYY-MM-DD
        completed: { type: boolean }
      required: [id, title, due, completed]

    TaskCreate:
      type: object
      additionalProperties: false
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        due:
          type: string
          format: date
          description: YYYY-MM-DD
        completed:
          type: boolean
          description: Optional, defaults to false
      required: [title, due]

    TaskUpdate:
      type: object
      additionalProperties: false
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        due:
          type: string
          format: date
        completed:
          type: boolean
      description: At least one of title, due, or completed is required.
      anyOf:
        - required: [title]
        - required: [due]
        - required: [completed]

    Error:
      type: object
      additionalProperties: false
      properties:
        error: { type: string }
      required: [error]
